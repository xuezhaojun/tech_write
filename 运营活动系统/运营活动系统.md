# 运营活动系统

### 业务需求 - 什么是活动系统？

作为电商网站，在不同的时间段，需要进行各种主题的销售活动，比如：

- 圣诞节期间，进行特价活动，将一批商品打折售卖

运营活动系统主要需要满足**3个功能性需求**：

1. 支持运营人员进行销售活动的配置，可以配置如活动开始时间，结束时间，哪些商品参与活动，哪些展板参活动，特殊文案，特殊图片，倒计时，折扣，特价等
2. 客户端请求活动系统，获取当前正在进行（以及后续一段时间）的活动列表
3. 客户端请求活动系统，查看某一个商品或者展坂是否位于某一个活动下，我们称之为活动归属的查询

流程为：

1. 运营人员为配置活动活动
2. 客户端请求活动信息
3. 客户端查询商品或展板的归属
4. 客户端根据配置渲染页面



### 其他需求

活动系统是一个 **Read-Heavy** 的系统，需要支持客户端大量的查询操作

活动系统需要具有**高可靠性**，可以忍受一定程度的不一致，比如运营人员刷新配置后，10秒之内前端现实配置更新，是可以接受的

需要为运营人员提供GUI的配置页面



### 结构图

[![6ImfmT.png](https://z3.ax1x.com/2021/03/22/6ImfmT.png)](https://imgtu.com/i/6ImfmT)

由图可见，我们的服务主要分为 **3个部分**：

- Activity_Service
  - 无状态服务，支持多机部署
  - 对客户端提供API服务
  - 缓存数据，支持高并发的请求
- Activity_Aggregate_Service
  - 检查当前最新的配置版本号，从storage的获取最新的配置信息
  - 访问替他微服务，聚合数据信息
- Activity_Config_System
  - 对运用人员提供GUI配置功能



我们关注其中数据同步的过程如下：

1. 运营人员每次提交更新后的配置，都会生成一个唯一的版本号 document_version

2. Activity_Config_System 将配置写入 storage 

3. Activity_Aggregate_Service 每10秒访问 Activity_Config_System 检查当前最新的document_version, 如果小于当前最新的版本号，则进行数据聚合，并更新自身的版本号
4. Activity_Service 每10秒访问 Activity_Aggregate_Service 检查当前最新的 document_version，如果小于当前最新的版本号，则进行请求 Activity_Aggregate_Service  刷新缓存